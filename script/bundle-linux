#!/usr/bin/env bash

set -euxo pipefail
source script/lib/blob-store.sh

# Function for displaying help info
help_info() {
  echo "
Usage: ${0##*/} [options]
Build a release .tar.gz for Linux.

Options:
  -h, --help     Display this help and exit.
  --flatpak      Set BSPTERM_BUNDLE_TYPE=flatpak so that this can be included in system info
  "
}

# Parse all arguments manually
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            help_info
            exit 0
            ;;
        --flatpak)
            export BSPTERM_BUNDLE_TYPE=flatpak
            shift
            ;;
        --)
            shift
            break
            ;;
        -*)
            echo "Unknown option: $1" >&2
            help_info
            exit 1
            ;;
        *)
            echo "Error: Unexpected argument: $1" >&2
            help_info
            exit 1
            ;;
    esac
done

export BSPTERM_BUNDLE=true

channel=$(<crates/bspterm/RELEASE_CHANNEL)
target_dir="${CARGO_TARGET_DIR:-target}"

version="$(script/get-crate-version bspterm)"
# Set RELEASE_VERSION so it's compiled into GPUI and it knows about the version.
export RELEASE_VERSION="${version}"

commit=$(git rev-parse HEAD | cut -c 1-7)

version_info=$(rustc --version --verbose)
host_line=$(echo "$version_info" | grep host)
target_triple=${host_line#*: }
musl_triple=${target_triple%-gnu}-musl
remote_server_triple=${REMOTE_SERVER_TARGET:-"${musl_triple}"}
rustup_installed=false
if command -v rustup >/dev/null 2>&1; then
    rustup_installed=true
fi

# Generate the licenses first, so they can be baked into the binaries
script/generate-licenses

if "$rustup_installed"; then
    rustup target add "$remote_server_triple"
fi

export CC=$(which clang)

# Build binary in release mode
export RUSTFLAGS="${RUSTFLAGS:-} -C link-args=-Wl,--disable-new-dtags,-rpath,\$ORIGIN/../lib"
cargo build --release --target "${target_triple}" --package bspterm --package cli
# Build remote_server in separate invocation to prevent feature unification from other crates
# from influencing dynamic libraries required by it.
if [[ "$remote_server_triple" == "$musl_triple" ]]; then
    export RUSTFLAGS="${RUSTFLAGS:-} -C target-feature=+crt-static"
fi
cargo build --release --target "${remote_server_triple}" --package remote_server

# Upload debug info to sentry.io
if ! command -v sentry-cli >/dev/null 2>&1; then
    echo "sentry-cli not found. skipping sentry upload."
    echo "install with: 'curl -sL https://sentry.io/get-cli | bash'"
else
    if [[ -n "${SENTRY_AUTH_TOKEN:-}" ]]; then
        echo "Uploading bspterm debug symbols to sentry..."
        # note: this uploads the unstripped binary which is needed because it contains
        # .eh_frame data for stack unwinding. see https://github.com/getsentry/symbolic/issues/783
        for attempt in 1 2 3; do
            echo "Attempting sentry upload (attempt $attempt/3)..."
            if sentry-cli debug-files upload --include-sources --wait -p bspterm -o bspterm-dev \
                "${target_dir}/${target_triple}"/release/bspterm \
                "${target_dir}/${remote_server_triple}"/release/remote_server; then
                echo "Sentry upload successful on attempt $attempt"
                break
            else
                echo "Sentry upload failed on attempt $attempt"
                if [ $attempt -eq 3 ]; then
                    echo "All sentry upload attempts failed"
                fi
            fi
        done
    else
        echo "missing SENTRY_AUTH_TOKEN. skipping sentry upload."
    fi
fi

# Strip debug symbols and save them for upload to DigitalOcean
objcopy --strip-debug "${target_dir}/${target_triple}/release/bspterm"
objcopy --strip-debug "${target_dir}/${target_triple}/release/cli"
objcopy --strip-debug "${target_dir}/${remote_server_triple}/release/remote_server"

# Ensure that remote_server does not depend on libssl nor libcrypto, as we got rid of these deps.
if ldd "${target_dir}/${remote_server_triple}/release/remote_server" | grep -q 'libcrypto\|libssl'; then
    if [[ "$remote_server_triple" == *-musl ]]; then
        echo "Error: remote_server still depends on libssl or libcrypto" && exit 1
    else
        echo "Info: Using non-musl remote-server build."
    fi
fi

suffix=""
if [ "$channel" != "stable" ]; then
  suffix="-$channel"
fi

# Move everything that should end up in the final package
# into a temp directory.
temp_dir=$(mktemp -d)
bspterm_dir="${temp_dir}/bspterm$suffix.app"

# Binary
mkdir -p "${bspterm_dir}/bin" "${bspterm_dir}/libexec"
cp "${target_dir}/${target_triple}/release/bspterm" "${bspterm_dir}/libexec/bspterm-editor"
cp "${target_dir}/${target_triple}/release/cli" "${bspterm_dir}/bin/bspterm"

# Libs
find_libs() {
    ldd ${target_dir}/${target_triple}/release/bspterm |\
        cut -d' ' -f3 |\
        grep -v '\<\(libstdc++.so\|libc.so\|libgcc_s.so\|libm.so\|libpthread.so\|libdl.so\|libasound.so\)'
}

mkdir -p "${bspterm_dir}/lib"
rm -rf "${bspterm_dir}/lib/*"
cp $(find_libs) "${bspterm_dir}/lib"

# Icons
mkdir -p "${bspterm_dir}/share/icons/hicolor/512x512/apps"
cp "crates/bspterm/resources/app-icon$suffix.png" "${bspterm_dir}/share/icons/hicolor/512x512/apps/bspterm.png"
mkdir -p "${bspterm_dir}/share/icons/hicolor/1024x1024/apps"
cp "crates/bspterm/resources/app-icon$suffix@2x.png" "${bspterm_dir}/share/icons/hicolor/1024x1024/apps/bspterm.png"

# .desktop
export DO_STARTUP_NOTIFY="true"
export APP_CLI="bspterm"
export APP_ICON="bspterm"
export APP_ARGS="%U"
if [[ "$channel" == "preview" ]]; then
  export APP_NAME="Bspterm Preview"
elif [[ "$channel" == "nightly" ]]; then
  export APP_NAME="Bspterm Nightly"
elif [[ "$channel" == "dev" ]]; then
  export APP_NAME="Bspterm Devel"
else
  export APP_NAME="Bspterm"
fi

mkdir -p "${bspterm_dir}/share/applications"
envsubst < "crates/bspterm/resources/bspterm.desktop.in" > "${bspterm_dir}/share/applications/bspterm$suffix.desktop"
chmod +x "${bspterm_dir}/share/applications/bspterm$suffix.desktop"

# Copy generated licenses so they'll end up in archive too
cp "assets/licenses.md" "${bspterm_dir}/licenses.md"

# Bundle default configuration zip
script/bundle-default-config "${temp_dir}"

# Create archive out of everything that's in the temp directory
arch=$(uname -m)
archive="bspterm-linux-${arch}.tar.gz"

rm -rf "${archive}"
remove_match="bspterm(-[a-zA-Z0-9]+)?-linux-$(uname -m)\.tar\.gz"
ls "${target_dir}/release" | grep -E ${remove_match} | xargs -d "\n" -I {} rm -f "${target_dir}/release/{}" || true
tar -czvf "${target_dir}/release/$archive" -C ${temp_dir} "bspterm$suffix.app" "default_config.zip"

gzip -f --stdout --best "${target_dir}/${remote_server_triple}/release/remote_server" > "${target_dir}/bspterm-remote-server-linux-${arch}.gz"
